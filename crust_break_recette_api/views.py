import codecs
import re
import uuid
from django.conf import Settings
from django.http import HttpResponse, JsonResponse, HttpResponseRedirect
from .api import *
import base64
from base64 import decodestring
import os
from django.contrib.staticfiles.storage import staticfiles_storage
from django.views.decorators.csrf import csrf_exempt
from django.core.files.storage import FileSystemStorage


def detailRecette(request,recette_id):
    if settings.APP_ENV=="dev":
        return JsonResponse({'vegetarian': False, 'vegan': False, 'glutenFree': False, 'dairyFree': True, 'veryHealthy': False, 'cheap': False, 'veryPopular': False, 'sustainable': False, 'lowFodmap': False, 'weightWatcherSmartPoints': 9, 'gaps': 'no', 'preparationMinutes': 10, 'cookingMinutes': 10, 'aggregateLikes': 225, 'healthScore': 46, 'creditsText': 'Feed Me Phoebe', 'sourceName': 'Feed Me Phoebe', 'pricePerServing': 199.25, 'extendedIngredients': [{'id': 18079, 'aisle': 'Pasta and Rice', 'image': 'breadcrumbs.jpg', 'consistency': 'SOLID', 'name': 'breadcrumbs', 'nameClean': 'breadcrumbs', 'original': '1/2 cup fresh breadcrumbs (I used gluten-free!)', 'originalName': 'fresh breadcrumbs (I used gluten-free!)', 'amount': 0.5, 'unit': 'cup', 'meta': ['fresh', '(I used gluten-free!)'], 'measures': {'us': {'amount': 0.5, 'unitShort': 'cups', 'unitLong': 'cups'}, 'metric': {'amount': 118.294, 'unitShort': 'ml', 'unitLong': 'milliliters'}}}, {'id': 11135, 'aisle': 'Produce', 'image': 'cauliflower.jpg', 'consistency': 'SOLID', 'name': 'cauliflower', 'nameClean': 'cauliflower', 'original': '1 head of cauliflower', 'originalName': 'cauliflower', 'amount': 1.0, 'unit': 'head', 'meta': [], 'measures': {'us': {'amount': 1.0, 'unitShort': 'head', 'unitLong': 'head'}, 'metric': {'amount': 1.0, 'unitShort': 'head', 'unitLong': 'head'}}}, {'id': 11297, 'aisle': 'Produce;Spices and Seasonings', 'image': 'parsley.jpg', 'consistency': 'SOLID', 'name': 'fresh parsley', 'nameClean': 'parsley', 'original': '1 handful parsley, chopped', 'originalName': 'parsley, chopped', 'amount': 1.0, 'unit': 'handful', 'meta': ['chopped'], 'measures': {'us': {'amount': 1.0, 'unitShort': 'handful', 'unitLong': 'handful'}, 'metric': {'amount': 1.0, 'unitShort': 'handful', 'unitLong': 'handful'}}}, {'id': 2063, 'aisle': 'Produce', 'image': 'rosemary.jpg', 'consistency': 'SOLID', 'name': 'fresh rosemary', 'nameClean': 'fresh rosemary', 'original': '2 teaspoons fresh rosemary, chopped', 'originalName': 'fresh rosemary, chopped', 'amount': 2.0, 'unit': 'teaspoons', 'meta': ['fresh', 'chopped'], 'measures': {'us': {'amount': 2.0, 'unitShort': 'tsps', 'unitLong': 'teaspoons'}, 'metric': {'amount': 2.0, 'unitShort': 'tsps', 'unitLong': 'teaspoons'}}}, {'id': 9297, 'aisle': 'Dried Fruits;Produce;Baking', 'image': 'golden-raisins.jpg', 'consistency': 'SOLID', 'name': 'golden raisins', 'nameClean': 'golden raisins', 'original': '1/4 cup golden raisins, chopped', 'originalName': 'golden raisins, chopped', 'amount': 0.25, 'unit': 'cup', 'meta': ['chopped'], 'measures': {'us': {'amount': 0.25, 'unitShort': 'cups', 'unitLong': 'cups'}, 'metric': {'amount': 59.147, 'unitShort': 'ml', 'unitLong': 'milliliters'}}}, {'id': 4053, 'aisle': 'Oil, Vinegar, Salad Dressing', 'image': 'olive-oil.jpg', 'consistency': 'LIQUID', 'name': 'olive oil', 'nameClean': 'olive oil', 'original': '1/4 cup olive oil, divided', 'originalName': 'olive oil, divided', 'amount': 0.25, 'unit': 'cup', 'meta': ['divided'], 'measures': {'us': {'amount': 0.25, 'unitShort': 'cups', 'unitLong': 'cups'}, 'metric': {'amount': 59.147, 'unitShort': 'ml', 'unitLong': 'milliliters'}}}, {'id': 12147, 'aisle': 'Produce;Baking', 'image': 'pine-nuts.png', 'consistency': 'SOLID', 'name': 'pine nuts', 'nameClean': 'pine nuts', 'original': '1/2 cup pine nuts', 'originalName': 'pine nuts', 'amount': 0.5, 'unit': 'cup', 'meta': [], 'measures': {'us': {'amount': 0.5, 'unitShort': 'cups', 'unitLong': 'cups'}, 'metric': {'amount': 118.294, 'unitShort': 'ml', 'unitLong': 'milliliters'}}}, {'id': 1012047, 'aisle': 'Spices and Seasonings', 'image': 'salt.jpg', 'consistency': 'SOLID', 'name': 'sea salt', 'nameClean': 'coarse sea salt', 'original': '1 teaspoon sea salt', 'originalName': 'sea salt', 'amount': 1.0, 'unit': 'teaspoon', 'meta': [], 'measures': {'us': {'amount': 1.0, 'unitShort': 'tsp', 'unitLong': 'teaspoon'}, 'metric': {'amount': 1.0, 'unitShort': 'tsp', 'unitLong': 'teaspoon'}}}, {'id': 10211111, 'aisle': 'Ethnic Foods;Spices and Seasonings', 'image': 'dried-sumac.jpg', 'consistency': 'SOLID', 'name': 'sumac', 'nameClean': 'sumac', 'original': '1/2 teaspoon sumac', 'originalName': 'sumac', 'amount': 0.5, 'unit': 'teaspoon', 'meta': [], 'measures': {'us': {'amount': 0.5, 'unitShort': 'tsps', 'unitLong': 'teaspoons'}, 'metric': {'amount': 0.5, 'unitShort': 'tsps', 'unitLong': 'teaspoons'}}}], 'id': 479101, 'title': 'On the Job: Pan Roasted Cauliflower From Food52', 'readyInMinutes': 20, 'servings': 4, 'sourceUrl': 'http://feedmephoebe.com/2013/11/job-food52s-pan-roasted-cauliflower/', 'openLicense': -1, 'image': 'https://spoonacular.com/recipeImages/479101-556x370.jpg', 'imageType': 'jpg', 'summary': 'On the Job: Pan Roasted Cauliflower From Food52 is a <b>dairy free</b> side dish. One portion of this dish contains roughly <b>7g of protein</b>, <b>26g of fat</b>, and a total of <b>350 calories</b>. This recipe serves 4. For <b>$1.99 per serving</b>, this recipe <b>covers 20%</b> of your daily requirements of vitamins and minerals. This recipe is liked by 225 foodies and cooks. A mixture of breadcrumbs, rosemary, sea salt, and a handful of other ingredients are all it takes to make this recipe so tasty. From preparation to the plate, this recipe takes around <b>20 minutes</b>. All things considered, we decided this recipe <b>deserves a spoonacular score of 97%</b>. This score is tremendous. Try <a href="https://spoonacular.com/recipes/food52s-roasted-broccoli-with-smoked-paprika-vinaigrette-and-marcona-almonds-110229">Food52\'s Roasted Broccoli with Smoked Paprika Vinaigrette and Marconan Almonds</a>, <a href="https://spoonacular.com/recipes/sheet-pan-chicken-cauliflower-921598">Sheet Pan Chicken Cauliflower</a>, and <a href="https://spoonacular.com/recipes/sheet-pan-roasted-broccoli-918006">Sheet Pan Roasted Broccoli</a> for similar recipes.', 'cuisines': [], 'dishTypes': ['side dish'], 'diets': ['dairy free'], 'occasions': [], 'winePairing': {}, 'instructions': 'Cut the florets off the stems and and then chop them into tiny florets. You can also chop up the stems into tiny pieces if you want. You should have about 6 cups of chopped cauliflower. In a large skillet heat 2 tablespoons of olive oil over medium-high heat. Add the cauliflower, 1 teaspoon of salt, rosemary, and sumac. Sauté until cauliflower is tender and starts to brown a bit, stirring as necessary, about 15 minutes. You can also add a bit of olive oil if the pan starts to get too dry or the cauliflower is starting to stick. Meanwhile, in a small skillet, toast the pinenuts over medium heat until golden brown. Set aside. Heat the remaining 2 tablespoons of olive oil in the same pan. Once oil is shimmering, toss in the breadcrumbs and stir, toasting the breadcrumbs. Season with a pinch of kosher salt and a few turns of freshly ground black pepper. Remove from the heat and toss in half of the chopped parsley. When cauliflower is done, remove from the heat and season to taste with freshly ground black pepper and a pinch or so of salt if necessary. Toss in the toasted pine nuts, the chopped raisins, and the remaining parsley. When ready to serve, sprinkle the top with the toasted breadcrumbs and some pecorino.', 'analyzedInstructions': [{'name': '', 'steps': [{'number': 1, 'step': 'Cut the florets off the stems and and then chop them into tiny florets. You can also chop up the stems into tiny pieces if you want. You should have about 6 cups of chopped cauliflower. In a large skillet heat 2 tablespoons of olive oil over medium-high heat.', 'ingredients': [{'id': 11135, 'name': 'cauliflower', 'localizedName': 'cauliflower', 'image': 'cauliflower.jpg'}, {'id': 4053, 'name': 'olive oil', 'localizedName': 'olive oil', 'image': 'olive-oil.jpg'}], 'equipment': [{'id': 404645, 'name': 'frying pan', 'localizedName': 'frying pan', 'image': 'pan.png'}]}, {'number': 2, 'step': 'Add the cauliflower, 1 teaspoon of salt, rosemary, and sumac. Sauté until cauliflower is tender and starts to brown a bit, stirring as necessary, about 15 minutes. You can also add a bit of olive oil if the pan starts to get too dry or the cauliflower is starting to stick. Meanwhile, in a small skillet, toast the pinenuts over medium heat until golden brown. Set aside.', 'ingredients': [{'id': 11135, 'name': 'cauliflower', 'localizedName': 'cauliflower', 'image': 'cauliflower.jpg'}, {'id': 4053, 'name': 'olive oil', 'localizedName': 'olive oil', 'image': 'olive-oil.jpg'}, {'id': 12147, 'name': 'pine nuts', 'localizedName': 'pine nuts', 'image': 'pine-nuts.png'}, {'id': 2036, 'name': 'rosemary', 'localizedName': 'rosemary', 'image': 'rosemary.jpg'}, {'id': 10211111, 'name': 'sumac', 'localizedName': 'sumac', 'image': 'dried-sumac.jpg'}, {'id': 18070, 'name': 'toast', 'localizedName': 'toast', 'image': 'toast'}, {'id': 2047, 'name': 'salt', 'localizedName': 'salt', 'image': 'salt.jpg'}], 'equipment': [{'id': 404645, 'name': 'frying pan', 'localizedName': 'frying pan', 'image': 'pan.png'}], 'length': {'number': 15, 'unit': 'minutes'}}, {'number': 3, 'step': 'Heat the remaining 2 tablespoons of olive oil in the same pan. Once oil is shimmering, toss in the breadcrumbs and stir, toasting the breadcrumbs. Season with a pinch of kosher salt and a few turns of freshly ground black pepper.', 'ingredients': [{'id': 1002030, 'name': 'ground black pepper', 'localizedName': 'ground black pepper', 'image': 'pepper.jpg'}, {'id': 18079, 'name': 'breadcrumbs', 'localizedName': 'breadcrumbs', 'image': 'breadcrumbs.jpg'}, {'id': 1082047, 'name': 'kosher salt', 'localizedName': 'kosher salt', 'image': 'salt.jpg'}, {'id': 4053, 'name': 'olive oil', 'localizedName': 'olive oil', 'image': 'olive-oil.jpg'}, {'id': 4582, 'name': 'cooking oil', 'localizedName': 'cooking oil', 'image': 'vegetable-oil.jpg'}], 'equipment': [{'id': 404645, 'name': 'frying pan', 'localizedName': 'frying pan', 'image': 'pan.png'}]}, {'number': 4, 'step': 'Remove from the heat and toss in half of the chopped parsley. When cauliflower is done, remove from the heat and season to taste with freshly ground black pepper and a pinch or so of salt if necessary. Toss in the toasted pine nuts, the chopped raisins, and the remaining parsley. When ready to serve, sprinkle the top with the toasted breadcrumbs and some pecorino.', 'ingredients': [{'id': 1002030, 'name': 'ground black pepper', 'localizedName': 'ground black pepper', 'image': 'pepper.jpg'}, {'id': 18079, 'name': 'breadcrumbs', 'localizedName': 'breadcrumbs', 'image': 'breadcrumbs.jpg'}, {'id': 11135, 'name': 'cauliflower', 'localizedName': 'cauliflower', 'image': 'cauliflower.jpg'}, {'id': 12147, 'name': 'pine nuts', 'localizedName': 'pine nuts', 'image': 'pine-nuts.png'}, {'id': 1038, 'name': 'pecorino', 'localizedName': 'pecorino', 'image': 'parmesan.jpg'}, {'id': 11297, 'name': 'parsley', 'localizedName': 'parsley', 'image': 'parsley.jpg'}, {'id': 9299, 'name': 'raisins', 'localizedName': 'raisins', 'image': 'raisins.jpg'}, {'id': 2047, 'name': 'salt', 'localizedName': 'salt', 'image': 'salt.jpg'}], 'equipment': []}]}], 'originalId': None, 'equipment': [{'name': 'frying pan', 'image': 'pan.png'}]})
    elif settings.APP_ENV=="prod":
        return JsonResponse(Api().getRecipeInformations(recette_id))
    else:
        return JsonResponse({'error':{'message':'missing the recipe id to search a recipe...'}})
    

def generateListeCourses(request):
    if request.GET.get('recipe') is not None or request.GET.get('recipe') is not '' :
        if settings.APP_ENV=="dev":
            return JsonResponse({'list': [{'quantity': '118.294 ml', 'ingredient': 'breadcrumbs'}, {'quantity': '1.0 head', 'ingredient': 'cauliflower'}, {'quantity': '1.0 handful', 'ingredient': 'fresh parsley'}, {'quantity': '2.0 tsps', 'ingredient': 'fresh rosemary'}, {'quantity': '59.147 ml', 'ingredient': 'golden raisins'}, {'quantity': '59.147 ml', 'ingredient': 'olive oil'}, {'quantity': '118.294 ml', 'ingredient': 'pine nuts'}, {'quantity': '1.0 tsp', 'ingredient': 'sea salt'}, {'quantity': '0.5 tsps', 'ingredient': 'sumac'}]})
        elif settings.APP_ENV=="prod":
            return JsonResponse(Api().getIngredients(int(request.GET.get('recipe'))))
    else:
        return JsonResponse({'error':{'message':'missing the recipe id to search a recipe...'}})
    

def searchRecette(request):
    if request.GET.get('name') is not None or request.GET.get('name') is not '' :
        query_dict = {
            'name':request.GET.get('name'),#name of the food : burger, pizza...
            'cuisine':request.GET.get('cuisine') if request.GET.get('cuisine') is not None or request.GET.get('cuisine') is not '' else '',#name of the cuisine : american, african...
            'type':request.GET.get('type') if request.GET.get('type') is not None or request.GET.get('type') is not '' else '',#type of meal : main course, entry...
            'diet':request.GET.get('diet') if request.GET.get('diet') is not None or request.GET.get('diet') is not '' else '',#type of diet : paleo, primal, and vegetarian...
            'exclude':request.GET.get('exclude') if request.GET.get('exclude') is not None or request.GET.get('exclude') is not ''  else ''
        }
        if settings.APP_ENV=="dev":
            return JsonResponse({'results': [{'id': 492564, 'title': 'Falafel Burgers with Feta Cucumber Sauce', 'image': 'https://spoonacular.com/recipeImages/492564-312x231.jpg', 'imageType': 'jpg'}, {'id': 246916, 'title': 'Bison Burger', 'image': 'https://spoonacular.com/recipeImages/246916-312x231.jpg', 'imageType': 'jpg'}, {'id': 245166, 'title': 'Hawaiian Pork Burger', 'image': 'https://spoonacular.com/recipeImages/245166-312x231.jpg', 'imageType': 'jpg'}, {'id': 246009, 'title': 'Blue Cheese Burgers', 'image': 'https://spoonacular.com/recipeImages/246009-312x231.jpg', 'imageType': 'jpg'}, {'id': 219957, 'title': 'Carrot & sesame burgers', 'image': 'https://spoonacular.com/recipeImages/219957-312x231.jpg', 'imageType': 'jpg'}, {'id': 607109, 'title': 'Turkey Zucchini Burger with Garlic Mayo', 'image': 'https://spoonacular.com/recipeImages/607109-312x231.jpg', 'imageType': 'jpg'}, {'id': 864633, 'title': 'Banh Mi Burgers with Spicy Sriracha Mayo', 'image': 'https://spoonacular.com/recipeImages/864633-312x231.jpg', 'imageType': 'jpg'}, {'id': 219871, 'title': 'Halloumi aubergine burgers with harissa relish', 'image': 'https://spoonacular.com/recipeImages/219871-312x231.jpg', 'imageType': 'jpg'}, {'id': 246177, 'title': 'Grilled Beef and Mushroom Burger', 'image': 'https://spoonacular.com/recipeImages/246177-312x231.jpg', 'imageType': 'jpg'}, {'id': 245343, 'title': 'Herbed Turkey Burger', 'image': 'https://spoonacular.com/recipeImages/245343-312x231.jpg', 'imageType': 'jpg'}, {'id': 593801, 'title': 'Turkey Burgers with Mango Chutney', 'image': 'https://spoonacular.com/recipeImages/593801-312x231.jpg', 'imageType': 'jpg'}, {'id': 763819, 'title': 'The Best Burgers', 'image': 'https://spoonacular.com/recipeImages/763819-312x231.jpg', 'imageType': 'jpg'}, {'id': 210685, 'title': 'The great breakfast burger', 'image': 'https://spoonacular.com/recipeImages/210685-312x231.jpg', 'imageType': 'jpg'}, {'id': 246593, 'title': 'German Pork Burger', 'image': 'https://spoonacular.com/recipeImages/246593-312x231.jpg', 'imageType': 'jpg'}, {'id': 245959, 'title': 'Jamaican Jerk Burgers', 'image': 'https://spoonacular.com/recipeImages/245959-312x231.jpg', 'imageType': 'jpg'}, {'id': 516544, 'title': 'Falafel Burgers with Creamy Feta Sauce', 'image': 'https://spoonacular.com/recipeImages/516544-312x231.jpg', 'imageType': 'jpg'}, {'id': 521885, 'title': 'Pesto & Mozzarella Turkey Burger', 'image': 'https://spoonacular.com/recipeImages/521885-312x231.jpg', 'imageType': 'jpg'}, {'id': 220182, 'title': 'Turkey burgers with beetroot relish', 'image': 'https://spoonacular.com/recipeImages/220182-312x231.jpg', 'imageType': 'jpg'}, {'id': 245306, 'title': 'Spicy Grilled Turkey Burger with Coleslaw', 'image': 'https://spoonacular.com/recipeImages/245306-312x231.jpg', 'imageType': 'jpg'}, {'id': 573337, 'title': 'Spicy Mango Black Bean Turkey Burgers', 'image': 'https://spoonacular.com/recipeImages/573337-312x231.jpg', 'imageType': 'jpg'}], 'baseUri': 'https://spoonacular.com/recipeImages/', 'offset': 0, 'number': 20, 'totalResults': 198, 'processingTimeMs': 179})
        elif settings.APP_ENV=="prod":
            return JsonResponse(Api().searchRecipe(query_dict))
    else:
        return JsonResponse({'error':{'message':'missing the query string to search a recipe...'}})

@csrf_exempt
def generateRecipe(request):
    if settings.APP_ENV=="dev":
        return JsonResponse({'results': [{'id': 492564, 'title': 'Falafel Burgers with Feta Cucumber Sauce', 'image': 'https://spoonacular.com/recipeImages/492564-312x231.jpg', 'imageType': 'jpg'}, {'id': 246916, 'title': 'Bison Burger', 'image': 'https://spoonacular.com/recipeImages/246916-312x231.jpg', 'imageType': 'jpg'}, {'id': 245166, 'title': 'Hawaiian Pork Burger', 'image': 'https://spoonacular.com/recipeImages/245166-312x231.jpg', 'imageType': 'jpg'}, {'id': 246009, 'title': 'Blue Cheese Burgers', 'image': 'https://spoonacular.com/recipeImages/246009-312x231.jpg', 'imageType': 'jpg'}, {'id': 219957, 'title': 'Carrot & sesame burgers', 'image': 'https://spoonacular.com/recipeImages/219957-312x231.jpg', 'imageType': 'jpg'}, {'id': 607109, 'title': 'Turkey Zucchini Burger with Garlic Mayo', 'image': 'https://spoonacular.com/recipeImages/607109-312x231.jpg', 'imageType': 'jpg'}, {'id': 864633, 'title': 'Banh Mi Burgers with Spicy Sriracha Mayo', 'image': 'https://spoonacular.com/recipeImages/864633-312x231.jpg', 'imageType': 'jpg'}, {'id': 219871, 'title': 'Halloumi aubergine burgers with harissa relish', 'image': 'https://spoonacular.com/recipeImages/219871-312x231.jpg', 'imageType': 'jpg'}, {'id': 246177, 'title': 'Grilled Beef and Mushroom Burger', 'image': 'https://spoonacular.com/recipeImages/246177-312x231.jpg', 'imageType': 'jpg'}, {'id': 245343, 'title': 'Herbed Turkey Burger', 'image': 'https://spoonacular.com/recipeImages/245343-312x231.jpg', 'imageType': 'jpg'}, {'id': 593801, 'title': 'Turkey Burgers with Mango Chutney', 'image': 'https://spoonacular.com/recipeImages/593801-312x231.jpg', 'imageType': 'jpg'}, {'id': 763819, 'title': 'The Best Burgers', 'image': 'https://spoonacular.com/recipeImages/763819-312x231.jpg', 'imageType': 'jpg'}, {'id': 210685, 'title': 'The great breakfast burger', 'image': 'https://spoonacular.com/recipeImages/210685-312x231.jpg', 'imageType': 'jpg'}, {'id': 246593, 'title': 'German Pork Burger', 'image': 'https://spoonacular.com/recipeImages/246593-312x231.jpg', 'imageType': 'jpg'}, {'id': 245959, 'title': 'Jamaican Jerk Burgers', 'image': 'https://spoonacular.com/recipeImages/245959-312x231.jpg', 'imageType': 'jpg'}, {'id': 516544, 'title': 'Falafel Burgers with Creamy Feta Sauce', 'image': 'https://spoonacular.com/recipeImages/516544-312x231.jpg', 'imageType': 'jpg'}, {'id': 521885, 'title': 'Pesto & Mozzarella Turkey Burger', 'image': 'https://spoonacular.com/recipeImages/521885-312x231.jpg', 'imageType': 'jpg'}, {'id': 220182, 'title': 'Turkey burgers with beetroot relish', 'image': 'https://spoonacular.com/recipeImages/220182-312x231.jpg', 'imageType': 'jpg'}, {'id': 245306, 'title': 'Spicy Grilled Turkey Burger with Coleslaw', 'image': 'https://spoonacular.com/recipeImages/245306-312x231.jpg', 'imageType': 'jpg'}, {'id': 573337, 'title': 'Spicy Mango Black Bean Turkey Burgers', 'image': 'https://spoonacular.com/recipeImages/573337-312x231.jpg', 'imageType': 'jpg'}], 'baseUri': 'https://spoonacular.com/recipeImages/', 'offset': 0, 'number': 20, 'totalResults': 198, 'processingTimeMs': 179})
    elif settings.APP_ENV=="prod":
        myfile = request.FILES.get('img')
        text_in_image = Api().getTextFromImage(FileSystemStorage().save(myfile.name, myfile))
        ingredient_in_text= Api().getIngredientsFromText(text_in_image)
        return JsonResponse(Api().searchRecipeByIngredient(ingredient_in_text))